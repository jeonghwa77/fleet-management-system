@using FleetManagementSystem4.Shared.Models
@inject IJSRuntime JSRuntime

<!-- ì„±ê³µ ë©”ì‹œì§€ -->
@if (ShowSuccess)
{
    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center">
        <span class="text-green-600 mr-2">âœ“</span>
        <span class="text-green-800">ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì˜ˆì•½ ê´€ë¦¬ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
    </div>
}

<!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
@if (!string.IsNullOrEmpty(Error))
{
    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center">
        <span class="text-red-600 mr-2">âš </span>
        <span class="text-red-800">@Error</span>
    </div>
}

<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-2">ì°¨ëŸ‰ ì˜ˆì•½ ì‹ ì²­</h2>
        <p class="text-gray-600">ë²•ì¸ì°¨ëŸ‰ ì‚¬ìš©ì„ ìœ„í•´ ì˜ˆì•½ì„ ì‹ ì²­í•´ì£¼ì„¸ìš”. ì‹ ì²­ ì¦‰ì‹œ ì˜ˆì•½ì´ ì™„ë£Œë©ë‹ˆë‹¤.</p>
    </div>

    <EditForm Model="this" FormName="reservation-form" OnValidSubmit="HandleSubmit">
        <div class="space-y-6">
            <!-- ì‹ ì²­ì ì •ë³´ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">ì‹ ì²­ì ì„±ëª…</label>
                    <div class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700">
                        @(CurrentUser?.Name ?? "ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ")
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">ì†Œì† ë¶€ì„œ</label>
                    <div class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700">
                        @(CurrentUser?.Department ?? "ë¶€ì„œ ì •ë³´ ì—†ìŒ")
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš© ê¸°ê°„ ë° ì‹œê°„ -->
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <label class="text-base font-medium text-gray-700">ì‚¬ìš© ê¸°ê°„ ë° ì‹œê°„ *</label>
                    <button type="button" @onclick="HandleAllDayClick" disabled="@IsSubmitting"
                            class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center">
                        <span class="mr-1">ğŸ•’</span>
                        ì¢…ì¼
                    </button>
                </div>

                <!-- ì‹œì‘ì¼ì‹œ -->
                <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        <label class="font-medium text-blue-700">ì‚¬ìš© ì‹œì‘</label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="start-date" class="text-sm text-gray-600">ë‚ ì§œ</label>
                            <input type="date" @bind="StartDateValue" @bind:format="yyyy-MM-dd" id="start-date"
                                   min="@TodayString" required disabled="@IsSubmitting"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                        <div class="space-y-2">
                            <label for="start-time" class="text-sm text-gray-600">ì‹œê°„</label>
                            <select @bind="StartTime" @bind:after="OnDateTimeChanged" id="start-time"
                                    required disabled="@IsSubmitting"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">ì‹œê°„ ì„ íƒ</option>
                                <option value="00:00">00:00</option>
                                @foreach (var time in TimeSlots)
                                {
                                    <option value="@time">@time</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ì¢…ë£Œì¼ì‹œ -->
                <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                        <label class="font-medium text-red-700">ì‚¬ìš© ì¢…ë£Œ</label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="end-date" class="text-sm text-gray-600">ë‚ ì§œ</label>
                            <input type="date" @bind="EndDateValue" @bind:format="yyyy-MM-dd" id="end-date"
                                   min="@(StartDate ?? TodayString)" required disabled="@IsSubmitting"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                        <div class="space-y-2">
                            <label for="end-time" class="text-sm text-gray-600">ì‹œê°„</label>
                            <select @bind="EndTime" @bind:after="OnDateTimeChanged" id="end-time"
                                    required disabled="@IsSubmitting"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">ì‹œê°„ ì„ íƒ</option>
                                @foreach (var time in TimeSlots)
                                {
                                    <option value="@time">@time</option>
                                }
                                <option value="23:59">23:59</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ê¸°ê°„ ìš”ì•½ -->
                @if (!string.IsNullOrEmpty(StartDate) && !string.IsNullOrEmpty(EndDate) && 
                     !string.IsNullOrEmpty(StartTime) && !string.IsNullOrEmpty(EndTime))
                {
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm">
                            <span class="font-medium">ì„ íƒëœ ì‚¬ìš© ê¸°ê°„:</span><br />
                            <span class="text-blue-600">
                                @if (StartDate == EndDate)
                                {
                                    @($"{StartDate} {StartTime} ~ {EndTime}")
                                }
                                else
                                {
                                    @($"{StartDate} {StartTime} ~ {EndDate} {EndTime}")
                                }
                            </span>
                        </p>
                    </div>
                }
            </div>

            <!-- ì°¨ëŸ‰ ì„ íƒ -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">ì°¨ëŸ‰ ì„ íƒ *</label>
                @if (!string.IsNullOrEmpty(StartDate) && !string.IsNullOrEmpty(EndDate))
                {
                    <select @bind="SelectedVehicleId" required disabled="@(IsSubmitting || AvailableVehicles.Count == 0)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        @if (AvailableVehicles.Count > 0)
                        {
                            <option value="">@($"{AvailableVehicles.Count}ëŒ€ì˜ ì°¨ëŸ‰ ì„ íƒ ê°€ëŠ¥")</option>
                            @foreach (var vehicle in AvailableVehicles)
                            {
                                <option value="@vehicle.Id">
                                    @vehicle.Name (@vehicle.LicensePlate) - @vehicle.Type
                                    @if (vehicle.Status != "ì‚¬ìš© ê°€ëŠ¥") { @($"[{vehicle.Status}]") }
                                </option>
                            }
                        }
                        else
                        {
                            <option value="">ì„ íƒí•œ ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥í•œ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤</option>
                        }
                    </select>
                    
                    @if (AvailableVehicles.Count == 0)
                    {
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p class="text-sm text-gray-600">
                                ì„ íƒí•˜ì‹  ì‹œê°„ì—ëŠ” ì‚¬ìš© ê°€ëŠ¥í•œ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”.
                            </p>
                            @if (!string.IsNullOrEmpty(StartDate) && !string.IsNullOrEmpty(EndDate))
                            {
                                <div class="mt-2">
                                    <p class="text-xs text-gray-500 font-medium">ì˜ˆì•½ ì¶©ëŒ ìƒí™©:</p>
                                    @foreach (var vehicle in GetUnavailableVehicles())
                                    {
                                        <div class="text-xs text-gray-600 mt-1">
                                            â€¢ @vehicle.Name (@vehicle.LicensePlate): @GetVehicleUnavailableReason(vehicle.Id)
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-sm text-gray-600">
                            @if (StartDate == EndDate)
                            {
                                @($"{StartDate} {StartTime}-{EndTime}")
                            }
                            else
                            {
                                @($"{StartDate} {StartTime} ~ {EndDate} {EndTime}")
                            } ì‹œê°„ëŒ€ì— 
                            <span class="text-green-600 font-medium">@($"{AvailableVehicles.Count}ëŒ€")</span>ì˜ ì°¨ëŸ‰ì„ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    }
                }
                else
                {
                    <select disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                        <option>ë¨¼ì € ì‚¬ìš© ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                    </select>
                    <p class="text-sm text-gray-600">
                        ì‚¬ìš© ë‚ ì§œì™€ ì‹œê°„ì„ ì…ë ¥í•˜ë©´ í•´ë‹¹ ì‹œê°„ì— ì‚¬ìš© ê°€ëŠ¥í•œ ì°¨ëŸ‰ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                }
            </div>

            <!-- ì‚¬ìš© ëª©ì  -->
            <div class="space-y-2">
                <label for="purpose" class="block text-sm font-medium text-gray-700">ì‚¬ìš© ëª©ì  *</label>
                <textarea @bind="Purpose" rows="3" required disabled="@IsSubmitting" id="purpose"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="ì°¨ëŸ‰ ì‚¬ìš© ëª©ì ì„ ìƒì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
            </div>

            <button type="submit" disabled="@(IsSubmitting || AvailableVehicles.Count == 0 || 
                    string.IsNullOrEmpty(StartDate) || string.IsNullOrEmpty(EndDate) || 
                    string.IsNullOrEmpty(StartTime) || string.IsNullOrEmpty(EndTime))"
                    class="w-full px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                @if (IsSubmitting)
                {
                    <span class="flex items-center justify-center">
                        <span class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></span>
                        ì˜ˆì•½ ì¤‘...
                    </span>
                }
                else
                {
                    <span>ì˜ˆì•½ ì‹ ì²­í•˜ê¸°</span>
                }
            </button>
        </div>
    </EditForm>
</div>

<!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ -->
@if (showAlertModal)
{
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[60]" @onclick="CloseAlertModal">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white" @onclick:stopPropagation="true">
            <div class="mt-3 text-center">
                <!-- ì•„ì´ì½˜ -->
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4
                    @(alertType == "success" ? "bg-green-100" : 
                      alertType == "error" ? "bg-red-100" : 
                      alertType == "warning" ? "bg-yellow-100" : "bg-blue-100")">
                    <span class="text-2xl">
                        @(alertType == "success" ? "âœ…" : 
                          alertType == "error" ? "âŒ" : 
                          alertType == "warning" ? "âš ï¸" : "â„¹ï¸")
                    </span>
                </div>
                
                <!-- ì œëª© -->
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">
                    @(alertType == "success" ? "ì„±ê³µ" : 
                      alertType == "error" ? "ì˜¤ë¥˜" : 
                      alertType == "warning" ? "ê²½ê³ " : "ì•Œë¦¼")
                </h3>
                
                <!-- ë©”ì‹œì§€ -->
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">@alertMessage</p>
                </div>
                
                <!-- ë²„íŠ¼ -->
                <div class="items-center px-4 py-3">
                    <button @onclick="CloseAlertModal" 
                            class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public List<Vehicle> Vehicles { get; set; } = new();
    [Parameter] public List<Reservation> ExistingReservations { get; set; } = new();
    [Parameter] public User? CurrentUser { get; set; }
    [Parameter] public EventCallback<Reservation> OnSubmit { get; set; }

    private string TodayString => DateTime.Today.ToString("yyyy-MM-dd");
    private bool IsSubmitting { get; set; } = false;
    private bool ShowSuccess { get; set; } = false;
    private string? Error { get; set; }

    // ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
    private bool showAlertModal = false;
    private string alertMessage = "";
    private string alertType = "info"; // success, error, warning, info

    // í¼ ë°ì´í„°
    private string EmployeeName { get; set; } = "";
    private string Department { get; set; } = "";
    private string Purpose { get; set; } = "";
    private string? StartDate { get; set; }
    private string? EndDate { get; set; }
    private string? StartTime { get; set; } = "09:00";
    private string? EndTime { get; set; } = "18:00";
    private string SelectedVehicleId { get; set; } = "";

    // Helper properties for HTML date inputs
    private DateTime? StartDateValue
    {
        get => DateTime.TryParse(StartDate, out var date) ? date : null;
        set 
        { 
            StartDate = value?.ToString("yyyy-MM-dd");
            _ = OnDateTimeChanged(); // Fire and forget async call
        }
    }

    private DateTime? EndDateValue
    {
        get => DateTime.TryParse(EndDate, out var date) ? date : null;
        set 
        { 
            EndDate = value?.ToString("yyyy-MM-dd");
            _ = OnDateTimeChanged(); // Fire and forget async call
        }
    }

    private List<string> Departments = new() 
    { 
        "í”„ë¡œì íŠ¸ 1íŒ€", "í”„ë¡œì íŠ¸ 2íŒ€", "ì—°êµ¬ê°œë°œíŒ€", "ê²½ì˜ì§€ì›íŒ€", "ê¸°íƒ€" 
    };

    private List<string> TimeSlots = new()
    {
        "08:00", "08:30", "09:00", "09:30", "10:00", "10:30", "11:00", "11:30",
        "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30",
        "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30"
    };

    private List<Vehicle> AvailableVehicles { get; set; } = new();

    protected override void OnInitialized()
    {
        // ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
        if (CurrentUser != null)
        {
            EmployeeName = CurrentUser.Name ?? "";
            Department = CurrentUser.Department ?? "";
        }

        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ê°’ ì„¤ì •
        StartDate = TodayString;
        EndDate = TodayString;

        // ê°€ìš© ì°¨ëŸ‰ ì´ˆê¸° í•„í„°ë§
        FilterAvailableVehicles();
    }

    private void HandleAllDayClick()
    {
        StartTime = "00:00";
        EndTime = "23:59";
        OnDateTimeChanged();
    }

    private async Task OnDateTimeChanged(ChangeEventArgs e)
    {
        // ì¢…ë£Œ ë‚ ì§œê°€ ì‹œì‘ ë‚ ì§œë³´ë‹¤ ì´ì „ì¸ ê²½ìš° ì‹œì‘ ë‚ ì§œì™€ ê°™ê²Œ ìˆ˜ì •
        if (!string.IsNullOrEmpty(StartDate) && !string.IsNullOrEmpty(EndDate) && 
            string.Compare(EndDate, StartDate) < 0)
        {
            EndDate = StartDate;
        }

        FilterAvailableVehicles();
        StateHasChanged();
    }

    private async Task OnDateTimeChanged()
    {
        await OnDateTimeChanged(new ChangeEventArgs());
    }

    private void FilterAvailableVehicles()
    {
        // ì •ë¹„ ì¤‘ì´ ì•„ë‹Œ ëª¨ë“  ì°¨ëŸ‰ì„ ëŒ€ìƒìœ¼ë¡œ í•¨
        var baseAvailable = Vehicles.Where(v => v.Status != "ì •ë¹„ ì¤‘").ToList();

        // ë‚ ì§œê°€ ì…ë ¥ëœ ê²½ìš° ì¶©ëŒ ê²€ì‚¬ ìˆ˜í–‰ (ì‹œê°„ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
        if (string.IsNullOrEmpty(StartDate) || string.IsNullOrEmpty(EndDate))
        {
            AvailableVehicles = baseAvailable;
            StateHasChanged();
            return;
        }

        // ì‹œê°„ì´ ì…ë ¥ë˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
        var checkStartTime = string.IsNullOrEmpty(StartTime) ? "09:00" : StartTime;
        var checkEndTime = string.IsNullOrEmpty(EndTime) ? "18:00" : EndTime;

        AvailableVehicles = baseAvailable.Where(vehicle => 
            !IsTimeConflict(vehicle.Id, StartDate, EndDate, checkStartTime, checkEndTime)
        ).ToList();

        // ê°€ìš©í•œ ì°¨ëŸ‰ì´ ìˆì„ ë•Œ ì²« ë²ˆì§¸ ì°¨ëŸ‰ì„ ìë™ ì„ íƒ
        if (AvailableVehicles.Count > 0 && string.IsNullOrEmpty(SelectedVehicleId))
        {
            SelectedVehicleId = AvailableVehicles[0].Id;
        }
        else if (AvailableVehicles.Count == 0)
        {
            SelectedVehicleId = "";
        }
        else if (!string.IsNullOrEmpty(SelectedVehicleId) && 
                 !AvailableVehicles.Any(v => v.Id == SelectedVehicleId))
        {
            // í˜„ì¬ ì„ íƒëœ ì°¨ëŸ‰ì´ ê°€ìš© ëª©ë¡ì— ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì°¨ëŸ‰ìœ¼ë¡œ ë³€ê²½
            SelectedVehicleId = AvailableVehicles.FirstOrDefault()?.Id ?? "";
        }

        StateHasChanged();
    }

    private List<Vehicle> GetUnavailableVehicles()
    {
        if (string.IsNullOrEmpty(StartDate) || string.IsNullOrEmpty(EndDate))
            return new List<Vehicle>();

        var checkStartTime = string.IsNullOrEmpty(StartTime) ? "09:00" : StartTime;
        var checkEndTime = string.IsNullOrEmpty(EndTime) ? "18:00" : EndTime;

        return Vehicles.Where(v => 
            !AvailableVehicles.Contains(v) && 
            v.Status != "ì •ë¹„ ì¤‘"
        ).ToList();
    }

    private string GetVehicleUnavailableReason(string vehicleId)
    {
        if (string.IsNullOrEmpty(StartDate) || string.IsNullOrEmpty(EndDate))
            return "";

        var checkStartTime = string.IsNullOrEmpty(StartTime) ? "09:00" : StartTime;
        var checkEndTime = string.IsNullOrEmpty(EndTime) ? "18:00" : EndTime;

        var conflictingReservations = ExistingReservations.Where(r => 
            r.VehicleId == vehicleId && 
            (r.GetCurrentStatus() == "reserved" || r.GetCurrentStatus() == "in_use") &&
            IsTimeConflict(vehicleId, StartDate, EndDate, checkStartTime, checkEndTime)
        ).ToList();

        if (conflictingReservations.Any())
        {
            var reservation = conflictingReservations.First();
            return $"{reservation.StartDate} {reservation.StartTime}-{reservation.EndTime} ì˜ˆì•½ë¨";
        }

        return "ì‚¬ìš© ë¶ˆê°€";
    }

    private DateTime CreateDateTime(string dateStr, string timeStr)
    {
        return DateTime.Parse($"{dateStr}T{timeStr}:00");
    }

    private bool IsTimeConflict(string vehicleId, string checkStartDate, string checkEndDate, 
                               string checkStartTime, string checkEndTime)
    {
        var activeReservations = ExistingReservations.Where(reservation => 
            reservation.VehicleId == vehicleId && 
            (reservation.GetCurrentStatus() == "reserved" || reservation.GetCurrentStatus() == "in_use")
        ).ToList();

        // ìƒˆ ì˜ˆì•½ì˜ ì‹œì‘/ì¢…ë£Œ ì¼ì‹œ
        var newStart = CreateDateTime(checkStartDate, checkStartTime);
        var newEnd = CreateDateTime(checkEndDate, checkEndTime);

        return activeReservations.Any(reservation => {
            // ê¸°ì¡´ ì˜ˆì•½ì˜ ì‹œì‘/ì¢…ë£Œ ì¼ì‹œ
            var existingStart = CreateDateTime(reservation.StartDate, reservation.StartTime);
            var existingEnd = CreateDateTime(reservation.EndDate, reservation.EndTime);

            // ì‹œê°„ ê²¹ì¹¨ ê²€ì‚¬: ìƒˆ ì˜ˆì•½ì˜ ì‹œì‘ì´ ê¸°ì¡´ ì˜ˆì•½ ì¢…ë£Œë³´ë‹¤ ì´ë¥´ê³ ,
            // ìƒˆ ì˜ˆì•½ì˜ ì¢…ë£Œê°€ ê¸°ì¡´ ì˜ˆì•½ ì‹œì‘ë³´ë‹¤ ëŠ¦ì€ ê²½ìš°
            return newStart < existingEnd && newEnd > existingStart;
        });
    }

    private async Task HandleSubmit()
    {
        Error = null;

        // í•„ìˆ˜ ì…ë ¥ ê²€ì¦
        if (string.IsNullOrEmpty(SelectedVehicleId) || CurrentUser == null || 
            string.IsNullOrEmpty(CurrentUser.Name) || string.IsNullOrEmpty(CurrentUser.Department) || 
            string.IsNullOrEmpty(Purpose) || string.IsNullOrEmpty(StartDate) || string.IsNullOrEmpty(EndDate) || 
            string.IsNullOrEmpty(StartTime) || string.IsNullOrEmpty(EndTime))
        {
            Error = "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        var vehicle = Vehicles.FirstOrDefault(v => v.Id == SelectedVehicleId);
        if (vehicle == null)
        {
            Error = "ì„ íƒí•œ ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        // ì‹œê°„ ê²€ì¦
        if (string.Compare(StartTime, EndTime) >= 0)
        {
            Error = "ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.";
            return;
        }

        // ë‚ ì§œ ê²€ì¦
        if (string.Compare(StartDate, EndDate) > 0)
        {
            Error = "ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.";
            return;
        }

        // ê³¼ê±° ë‚ ì§œ ê²€ì¦
        if (string.Compare(StartDate, TodayString) < 0)
        {
            Error = "ì‹œì‘ì¼ì€ ì˜¤ëŠ˜ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.";
            return;
        }

        // ì‹œê°„ ì¶©ëŒ ê²€ì‚¬
        if (IsTimeConflict(SelectedVehicleId, StartDate, EndDate, StartTime, EndTime))
        {
            Error = "ì„ íƒí•œ ì‹œê°„ì— í•´ë‹¹ ì°¨ëŸ‰ì´ ì´ë¯¸ ì˜ˆì•½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
            return;
        }

        IsSubmitting = true;

        try
        {
            var reservation = new Reservation
            {
                Id = $"reservation_{DateTime.Now.Ticks}",
                VehicleId = SelectedVehicleId,
                VehicleName = vehicle.Name,
                UserId = CurrentUser?.Id ?? "unknown",
                UserName = CurrentUser?.Name ?? "",
                Department = CurrentUser?.Department ?? "",
                Purpose = Purpose,
                StartDate = StartDate,
                EndDate = EndDate,
                StartTime = StartTime,
                EndTime = EndTime,
                Status = "reserved", // ìŠ¹ì¸ ì—†ì´ ë°”ë¡œ ì˜ˆì•½ ì¤‘ ìƒíƒœ
                CreatedAt = DateTime.Now
            };

            await OnSubmit.InvokeAsync(reservation);

            // í¼ ì´ˆê¸°í™” (ì‚¬ìš©ì ì •ë³´ì™€ ê¸°ë³¸ ë‚ ì§œ/ì‹œê°„ì€ ìœ ì§€)
            SelectedVehicleId = "";
            Purpose = "";

            await ShowAlert($"ì°¨ëŸ‰ '{vehicle.Name}'ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        }
        catch (Exception ex)
        {
            await ShowAlert($"ì˜ˆì•½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: {ex.Message}", "error");
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    // ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ ë©”ì„œë“œë“¤
    private async Task ShowAlert(string message, string type = "info")
    {
        alertMessage = message;
        alertType = type;
        showAlertModal = true;
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private void CloseAlertModal()
    {
        showAlertModal = false;
        StateHasChanged();
    }
}
