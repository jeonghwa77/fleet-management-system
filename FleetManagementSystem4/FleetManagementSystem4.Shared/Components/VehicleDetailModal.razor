@using FleetManagementSystem4.Shared.Models

@code {
    [Parameter] public Vehicle? Vehicle { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<Vehicle> OnSave { get; set; }
    [Parameter] public EventCallback<string> OnDelete { get; set; }

    private bool IsEditing { get; set; } = false;
    private bool IsLoading { get; set; } = false;
    private Vehicle EditingVehicle { get; set; } = new();

    protected override void OnParametersSet()
    {
        if (Vehicle != null)
        {
            EditingVehicle = new Vehicle
            {
                Id = Vehicle.Id,
                Name = Vehicle.Name,
                Type = Vehicle.Type,
                LicensePlate = Vehicle.LicensePlate,
                Fuel = Vehicle.Fuel,
                Color = Vehicle.Color,
                Status = Vehicle.Status,
                Year = Vehicle.Year,
                Mileage = Vehicle.Mileage,
                LastMaintenance = Vehicle.LastMaintenance,
                NextMaintenance = Vehicle.NextMaintenance,
                InsuranceExpiry = Vehicle.InsuranceExpiry
            };
        }
    }

    private async Task SaveVehicle()
    {
        IsLoading = true;
        await Task.Delay(500); // API Ìò∏Ï∂ú ÏãúÎÆ¨Î†àÏù¥ÏÖò
        await OnSave.InvokeAsync(EditingVehicle);
        IsEditing = false;
        IsLoading = false;
    }

    private async Task DeleteVehicle()
    {
        if (Vehicle != null && await ConfirmDelete())
        {
            IsLoading = true;
            await Task.Delay(500);
            await OnDelete.InvokeAsync(Vehicle.Id);
            IsLoading = false;
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        // TODO: Ïã§Ï†ú ÌôïÏù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏ Íµ¨ÌòÑ
        return true;
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "ÏÇ¨Ïö© Í∞ÄÎä•" => "bg-green-100 text-green-700",
            "ÏòàÏïΩ Ï§ë" => "bg-blue-100 text-blue-700",
            "Ï†êÍ≤Ä Ï§ë" => "bg-yellow-100 text-yellow-700",
            "ÏàòÎ¶¨ Ï§ë" => "bg-red-100 text-red-700",
            _ => "bg-gray-100 text-gray-700"
        };
    }
}

@if (Vehicle != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Ìó§Îçî -->
            <div class="flex items-center justify-between p-6 border-b border-border">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                        <span class="text-2xl">üöó</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-foreground">
                            @(IsEditing ? "Ï∞®Îüâ Ï†ïÎ≥¥ ÏàòÏ†ï" : Vehicle.Name)
                        </h2>
                        <p class="text-sm text-muted-foreground">
                            @(IsEditing ? "Ï∞®Îüâ Ï†ïÎ≥¥Î•º ÏàòÏ†ïÌïòÏÑ∏Ïöî" : Vehicle.LicensePlate)
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    @if (!IsEditing)
                    {
                        <button @onclick="() => IsEditing = true" 
                                class="bg-secondary hover:bg-secondary/80 text-secondary-foreground px-3 py-2 rounded-md text-sm font-medium transition-colors">
                            ÏàòÏ†ï
                        </button>
                    }
                    <button @onclick="OnClose" 
                            class="text-muted-foreground hover:text-foreground p-2 rounded-md transition-colors">
                        ‚úï
                    </button>
                </div>
            </div>

            <!-- Î≥∏Î¨∏ -->
            <div class="p-6">
                @if (IsEditing)
                {
                    <!-- Ìé∏Ïßë Î™®Îìú -->
                    <div class="space-y-6">
                        <div class="grid gap-4 md:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Ï∞®ÎüâÎ™Ö</label>
                                <input @bind="EditingVehicle.Name" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Î≤àÌò∏Ìåê</label>
                                <input @bind="EditingVehicle.LicensePlate" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Ï∞®Ï¢Ö</label>
                                <select @bind="EditingVehicle.Type" 
                                        class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring">
                                    <option value="ÏäπÏö©Ï∞®">ÏäπÏö©Ï∞®</option>
                                    <option value="SUV">SUV</option>
                                    <option value="ÏäπÌï©Ï∞®">ÏäπÌï©Ï∞®</option>
                                    <option value="Ìä∏Îü≠">Ìä∏Îü≠</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Ïó∞Î£å</label>
                                <select @bind="EditingVehicle.Fuel" 
                                        class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring">
                                    <option value="ÌúòÎ∞úÏú†">ÌúòÎ∞úÏú†</option>
                                    <option value="Í≤ΩÏú†">Í≤ΩÏú†</option>
                                    <option value="LPG">LPG</option>
                                    <option value="Ï†ÑÍ∏∞">Ï†ÑÍ∏∞</option>
                                    <option value="ÌïòÏù¥Î∏åÎ¶¨Îìú">ÌïòÏù¥Î∏åÎ¶¨Îìú</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">ÏÉâÏÉÅ</label>
                                <input @bind="EditingVehicle.Color" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">ÏÉÅÌÉú</label>
                                <select @bind="EditingVehicle.Status" 
                                        class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring">
                                    <option value="ÏÇ¨Ïö© Í∞ÄÎä•">ÏÇ¨Ïö© Í∞ÄÎä•</option>
                                    <option value="ÏòàÏïΩ Ï§ë">ÏòàÏïΩ Ï§ë</option>
                                    <option value="Ï†êÍ≤Ä Ï§ë">Ï†êÍ≤Ä Ï§ë</option>
                                    <option value="ÏàòÎ¶¨ Ï§ë">ÏàòÎ¶¨ Ï§ë</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Ïó∞Ïãù</label>
                                <input @bind="EditingVehicle.Year" type="number" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Ï£ºÌñâÍ±∞Î¶¨ (km)</label>
                                <input @bind="EditingVehicle.Mileage" type="number" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                        </div>
                        
                        <div class="grid gap-4 md:grid-cols-3">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">ÏµúÍ∑º Ï†ïÎπÑÏùº</label>
                                <input @bind="EditingVehicle.LastMaintenance" type="date" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Îã§Ïùå Ï†ïÎπÑÏùº</label>
                                <input @bind="EditingVehicle.NextMaintenance" type="date" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">Î≥¥Ìóò ÎßåÎ£åÏùº</label>
                                <input @bind="EditingVehicle.InsuranceExpiry" type="date" 
                                       class="w-full px-3 py-2 border border-input rounded-lg focus:outline-none focus:ring-2 focus:ring-ring" />
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Î≥¥Í∏∞ Î™®Îìú -->
                    <div class="space-y-6">
                        <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                        <div>
                            <h3 class="text-lg font-semibold text-foreground mb-4 flex items-center">
                                <span class="mr-2">üîß</span>
                                Í∏∞Î≥∏ Ï†ïÎ≥¥
                            </h3>
                            <div class="grid gap-4 md:grid-cols-2">
                                <div class="flex justify-between py-2 border-b border-muted">
                                    <span class="text-muted-foreground">Ï∞®Ï¢Ö:</span>
                                    <span class="font-medium text-foreground">@Vehicle.Type</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-muted">
                                    <span class="text-muted-foreground">Ïó∞Î£å:</span>
                                    <span class="font-medium text-foreground">@Vehicle.Fuel</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-muted">
                                    <span class="text-muted-foreground">ÏÉâÏÉÅ:</span>
                                    <span class="font-medium text-foreground">@Vehicle.Color</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-muted">
                                    <span class="text-muted-foreground">ÏÉÅÌÉú:</span>
                                    <span class="@GetStatusClass(Vehicle.Status) px-2 py-1 rounded-full text-xs font-medium">
                                        @Vehicle.Status
                                    </span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-muted">
                                    <span class="text-muted-foreground">Ïó∞Ïãù:</span>
                                    <span class="font-medium text-foreground">@Vehicle.Year ÎÖÑ</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-muted">
                                    <span class="text-muted-foreground">Ï£ºÌñâÍ±∞Î¶¨:</span>
                                    <span class="font-medium text-foreground">@Vehicle.Mileage.ToString("N0") km</span>
                                </div>
                            </div>
                        </div>

                        <!-- Ï†ïÎπÑ Ï†ïÎ≥¥ -->
                        <div>
                            <h3 class="text-lg font-semibold text-foreground mb-4 flex items-center">
                                <span class="mr-2">üõ†Ô∏è</span>
                                Ï†ïÎπÑ Ï†ïÎ≥¥
                            </h3>
                            <div class="grid gap-4 md:grid-cols-3">
                                <div class="bg-muted/50 p-4 rounded-lg">
                                    <div class="text-sm text-muted-foreground">ÏµúÍ∑º Ï†ïÎπÑÏùº</div>
                                    <div class="font-medium text-foreground">@Vehicle.LastMaintenance?.ToString("yyyy-MM-dd")</div>
                                </div>
                                <div class="bg-muted/50 p-4 rounded-lg">
                                    <div class="text-sm text-muted-foreground">Îã§Ïùå Ï†ïÎπÑÏùº</div>
                                    <div class="font-medium text-foreground">@Vehicle.NextMaintenance?.ToString("yyyy-MM-dd")</div>
                                </div>
                                <div class="bg-muted/50 p-4 rounded-lg">
                                    <div class="text-sm text-muted-foreground">Î≥¥Ìóò ÎßåÎ£åÏùº</div>
                                    <div class="font-medium text-foreground">@Vehicle.InsuranceExpiry?.ToString("yyyy-MM-dd")</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Ìë∏ÌÑ∞ -->
            <div class="flex items-center justify-between p-6 border-t border-border">
                @if (IsEditing)
                {
                    <button @onclick="DeleteVehicle" 
                            class="border border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground px-4 py-2 rounded-lg transition-colors font-medium"
                            disabled="@IsLoading">
                        ÏÇ≠Ï†ú
                    </button>
                    <div class="flex space-x-2">
                        <button @onclick="() => IsEditing = false" 
                                class="bg-secondary hover:bg-secondary/80 text-secondary-foreground px-4 py-2 rounded-lg transition-colors font-medium">
                            Ï∑®ÏÜå
                        </button>
                        <button @onclick="SaveVehicle" 
                                class="bg-primary hover:bg-primary/90 text-primary-foreground px-4 py-2 rounded-lg transition-colors font-medium"
                                disabled="@IsLoading">
                            @(IsLoading ? "Ï†ÄÏû• Ï§ë..." : "Ï†ÄÏû•")
                        </button>
                    </div>
                }
                else
                {
                    <div></div>
                    <button @onclick="OnClose" 
                            class="bg-secondary hover:bg-secondary/80 text-secondary-foreground px-4 py-2 rounded-lg transition-colors font-medium">
                        Îã´Í∏∞
                    </button>
                }
            </div>
        </div>
    </div>
}
