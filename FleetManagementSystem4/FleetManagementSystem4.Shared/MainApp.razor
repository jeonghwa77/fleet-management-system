@page "/"
@using Microsoft.AspNetCore.Components
@using FleetManagementSystem4.Shared.Models
@using FleetManagementSystem4.Shared.Pages
@using FleetManagementSystem4.Shared.Components
@using FleetManagementSystem4.Shared.Services
@using FleetManagementSystem4.Shared.Layout

@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject SupabaseService SupabaseService
@inject IJSRuntime JSRuntime

@if (IsAuthChecking)
{
    <div class="min-h-screen bg-background flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin">ğŸ”„</div>
            <p class="text-muted-foreground mt-4">ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
        </div>
    </div>
}
else if (!IsAuthenticated)
{
    <AuthScreen @ref="authScreenRef"
                OnSignIn="@(args => HandleSignIn(args.Email, args.Password))" 
                OnSignUp="@HandleSignUp" />
}
else
{
    <div class="min-h-screen bg-background">
        <!-- PWA ìŠ¤íƒ€ì¼ í—¤ë” -->
        <div class="sticky top-0 z-50 bg-background border-b border-border">
            <div class="container mx-auto px-4 md:px-6">
                <div class="flex items-center justify-between h-14 md:h-16">
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center justify-center w-8 h-8 bg-primary rounded-lg">
                            <span class="text-primary-foreground text-xl">ğŸš—</span>
                        </div>
                        <div>
                            <h1 class="text-lg md:text-xl font-semibold text-foreground">ë²•ì¸ì°¨ëŸ‰ ì˜ˆì•½ê´€ë¦¬</h1>
                            <p class="text-sm text-muted-foreground hidden md:block">íšŒì‚¬ ì°¨ëŸ‰ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ì˜ˆì•½í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-muted-foreground hidden md:block">
                            @UserName
                        </span>
                        <button class="h-8 w-8 p-0 bg-transparent hover:bg-muted rounded-md text-muted-foreground transition-colors" 
                                @onclick="HandleSignOut" 
                                title="ë¡œê·¸ì•„ì›ƒ">
                            <span class="text-base">â†—</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="container mx-auto px-4 md:px-6 py-6 max-w-6xl">
            
            <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="grid w-full grid-cols-4 mb-6 bg-muted rounded-lg p-1">
                <button class="@GetTabClass("dashboard")" @onclick="@(() => SetActiveTab("dashboard"))">
                    <span class="mr-2">ğŸ“Š</span>
                    <span class="text-xs md:text-sm">ëŒ€ì‹œë³´ë“œ</span>
                </button>
                <button class="@GetTabClass("vehicles")" @onclick="@(() => SetActiveTab("vehicles"))">
                    <span class="mr-2">ğŸš—</span>
                    <span class="text-xs md:text-sm">ì°¨ëŸ‰ ëª©ë¡</span>
                </button>
                <button class="@GetTabClass("reservation")" @onclick="@(() => SetActiveTab("reservation"))">
                    <span class="mr-2">â•</span>
                    <span class="text-xs md:text-sm">ì˜ˆì•½ ì‹ ì²­</span>
                </button>
                <button class="@GetTabClass("management")" @onclick="@(() => SetActiveTab("management"))">
                    <span class="mr-2">ğŸ“‹</span>
                    <span class="text-xs md:text-sm">ì˜ˆì•½ ê´€ë¦¬</span>
                </button>
            </div>

            <!-- íƒ­ ì»¨í…ì¸  -->
            <div class="space-y-4">
                @if (ActiveTab == "dashboard")
                {
                    <Dashboard Vehicles="@SampleVehicles" 
                              Reservations="@Reservations"
                              IsMobile="@IsMobile" />
                }
                else if (ActiveTab == "vehicles")
                {
                    <VehicleList vehicles="@SampleVehicles" 
                                 isMobile="@false"
                                 onAdd="@OnAddVehicle"
                                 onUpdate="@OnUpdateVehicle" 
                                 onDelete="@OnDeleteVehicle" />
                }
                else if (ActiveTab == "reservation")
                {
                    <ReservationForm Vehicles="@SampleVehicles"
                                   ExistingReservations="@Reservations"
                                   CurrentUser="@CurrentUserInfo"
                                   OnSubmit="@HandleAddReservation" />
                }
                else if (ActiveTab == "management")
                {
                    <ReservationManagement3 Reservations="@Reservations" 
                                          Vehicles="@SampleVehicles"
                                          CurrentUser="@CurrentUserInfo"
                                          OnReservationCancelled="@HandleReservationCancelled"
                                          OnReservationCompleted="@HandleReservationCompleted" />
                }
                else
                {
                    <div class="bg-red-100 p-4 rounded">
                        <p>ì•Œ ìˆ˜ ì—†ëŠ” íƒ­: @ActiveTab</p>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private bool IsAuthChecking { get; set; } = true;
    private bool IsAuthenticated => AuthService.IsAuthenticated;
    private string? UserName => AuthService.UserName;
    private string? Error { get; set; }
    private string ActiveTab { get; set; } = "dashboard";
    private bool IsMobile { get; set; } = false;

    // EventCallback í”„ë¡œí¼í‹°ë“¤
    private EventCallback<Vehicle> OnAddVehicle => EventCallback.Factory.Create<Vehicle>(this, HandleAddVehicle);
    private EventCallback<(string, Vehicle)> OnUpdateVehicle => EventCallback.Factory.Create<(string, Vehicle)>(this, HandleUpdateVehicle);
    private EventCallback<string> OnDeleteVehicle => EventCallback.Factory.Create<string>(this, HandleDeleteVehicle);

    protected override async Task OnInitializedAsync()
    {
        // ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹œë®¬ë ˆì´ì…˜
        await Task.Delay(800); 
        IsAuthChecking = false;
        
        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
        UpdateCurrentUserInfo();
        
        // Supabaseì—ì„œ ë°ì´í„° ë¡œë“œ
        await LoadDataFromSupabase();
        
        // ìë™ ì™„ë£Œ ì²˜ë¦¬ íƒ€ì´ë¨¸ ì‹œì‘ (1ë¶„ë§ˆë‹¤ ì‹¤í–‰)
        _ = StartAutoCompletionTimer();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // í™”ë©´ ë„ˆë¹„ í™•ì¸ (768px ì´í•˜ë©´ ëª¨ë°”ì¼ë¡œ ê°„ì£¼)
                var width = await JSRuntime.InvokeAsync<int>("eval", "window.innerWidth");
                IsMobile = width <= 768;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"í™”ë©´ í¬ê¸° ê°ì§€ ì˜¤ë¥˜: {ex.Message}");
                // ê¸°ë³¸ê°’ìœ¼ë¡œ ë°ìŠ¤í¬í†± ì‚¬ìš©
                IsMobile = false;
            }
        }
    }

    private async Task LoadDataFromSupabase()
    {
        try
        {
            // ì°¨ëŸ‰ ë°ì´í„° ë¡œë“œ
            await LoadVehiclesFromSupabase();
            
            // ì˜ˆì•½ ë°ì´í„° ë¡œë“œ
            await LoadReservationsFromSupabase();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {ex.Message}");
        }
    }

    private async Task LoadVehiclesFromSupabase()
    {
        try
        {
            var vehicles = await SupabaseService.GetVehiclesAsync();
            
            if (vehicles.Count > 0)
            {
                SampleVehicles = vehicles;
                Console.WriteLine($"Supabaseì—ì„œ {vehicles.Count}ê°œ ì°¨ëŸ‰ ë¡œë“œë¨");
            }
            else
            {
                Console.WriteLine("Supabaseì—ì„œ ì°¨ëŸ‰ ë°ì´í„°ê°€ ì—†ì–´ì„œ ê¸°ë³¸ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©");
                LoadDefaultVehicleData();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ì°¨ëŸ‰ ë¡œë“œ ì˜¤ë¥˜: {ex.Message}");
            Console.WriteLine("ì˜¤ë¥˜ë¡œ ì¸í•´ ê¸°ë³¸ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©");
            LoadDefaultVehicleData();
            StateHasChanged();
        }
    }

    private void LoadDefaultVehicleData()
    {
        SampleVehicles = new List<Vehicle>
        {
            new Vehicle
            {
                Id = "vehicle_1",
                Name = "ìŠ¤íƒ€ë¦¬ì•„",
                Type = "ìŠ¹í•©ì°¨",
                LicensePlate = "839ë£¨7772",
                Capacity = 5,
                Fuel = "íœ˜ë°œìœ ",
                Status = "Available",
                Color = "blue",
                Description = "ìŠ¹í•©ì°¨ëŸ‰, ë‹¨ì²´ ì´ë™ìš©",
                Year = 2023,
                Mileage = 15000,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            },
            new Vehicle
            {
                Id = "vehicle_2",
                Name = "ì½”ë‚˜",
                Type = "ìŠ¹ìš©ì°¨",
                LicensePlate = "264ì–´7952",
                Capacity = 5,
                Fuel = "íœ˜ë°œìœ ",
                Status = "Available",
                Color = "green",
                Description = "ì†Œí˜• SUV, ì‹œë‚´ ì´ë™ìš©",
                Year = 2022,
                Mileage = 25000,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            },
            new Vehicle
            {
                Id = "vehicle_3",
                Name = "íˆ¬ì‹¼",
                Type = "ìŠ¹ìš©ì°¨",
                LicensePlate = "134ë„ˆ8690",
                Capacity = 5,
                Fuel = "íœ˜ë°œìœ ",
                Status = "Available",
                Color = "red",
                Description = "ì¤‘í˜• SUV, ì¼ë°˜ ì—…ë¬´ìš©",
                Year = 2023,
                Mileage = 18000,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            },
            new Vehicle
            {
                Id = "vehicle_4",
                Name = "ë´‰ê³ ",
                Type = "í™”ë¬¼ì°¨",
                LicensePlate = "91ì£¼8861",
                Capacity = 4,
                Fuel = "íœ˜ë°œìœ ",
                Status = "Available",
                Color = "orange",
                Description = "ì†Œí˜• í™”ë¬¼ì°¨, ë¬¼í’ˆ ìš´ì†¡ìš©",
                Year = 2021,
                Mileage = 45000,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now
            }
        };
    }



    private void UpdateCurrentUserInfo()
    {
        if (IsAuthenticated && AuthService.CurrentUser != null)
        {
            CurrentUserInfo = AuthService.CurrentUser;
        }
        else
        {
            // ê¸°ë³¸ê°’ ì„¤ì • (ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°)
            CurrentUserInfo = new User
            {
                Id = "guest",
                Name = "ê²ŒìŠ¤íŠ¸",
                Department = "ë¯¸ì •",
                Email = "guest@company.com"
            };
        }
        StateHasChanged();
    }

    private async Task HandleSignIn(string email, string password)
    {
        IsAuthChecking = true;
        var result = await AuthService.SignInAsync(email, password);
        IsAuthChecking = false;
        
        if (result)
        {
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
            UpdateCurrentUserInfo();
            NavigationManager.NavigateTo("/dashboard");
        }
        else
        {
            Error = "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        }
    }

    private AuthScreen? authScreenRef;

    private async Task HandleSignUp(AuthScreen.AuthScreenSignUpArgs args)
    {
        try
        {
            var result = await AuthService.SignUpAsync(args.Email, args.Password, args.Name, args.Department);
            
            if (result.Success)
            {
                // íšŒì›ê°€ì… ì„±ê³µ ì‹œ AuthScreenì— ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                authScreenRef?.ShowSignUpSuccess();
            }
            else
            {
                // íšŒì›ê°€ì… ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                authScreenRef?.ShowSignUpError(result.Message);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"íšŒì›ê°€ì… ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
            authScreenRef?.ShowSignUpError("íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    private void HandleSignOut()
    {
        Console.WriteLine("ğŸšª ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ë¨");
        AuthService.SignOut();
        Console.WriteLine("âœ… ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì™„ë£Œ");
        NavigationManager.NavigateTo("/");
        Console.WriteLine("ğŸ”„ í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì™„ë£Œ");
    }

    private void SetActiveTab(string tab)
    {
        Console.WriteLine($"ğŸ”„ íƒ­ ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ: {ActiveTab} -> {tab}");
        ActiveTab = tab;
        StateHasChanged();
        Console.WriteLine($"âœ… íƒ­ ë³€ê²½ ì™„ë£Œ: í˜„ì¬ íƒ­ = {ActiveTab}");
    }

    private string GetTabClass(string tab)
    {
        var baseClass = "flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md transition-colors";
        var activeClass = "bg-background text-foreground shadow-sm";
        var inactiveClass = "text-muted-foreground hover:text-foreground";
        
        return ActiveTab == tab ? $"{baseClass} {activeClass}" : $"{baseClass} {inactiveClass}";
    }

    // ì°¨ëŸ‰ ë°ì´í„° (Supabaseì—ì„œ ë¡œë“œë¨)
    private List<Vehicle> SampleVehicles { get; set; } = new();

    // ì˜ˆì•½ ë°ì´í„° (Supabaseì—ì„œ ë¡œë“œë¨)
    private List<Reservation> Reservations { get; set; } = new();

    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ (ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨)
    private User CurrentUserInfo { get; set; } = new();

    // ì°¨ëŸ‰ CRUD ë©”ì„œë“œë“¤
    private async Task HandleAddVehicle(Vehicle vehicle)
    {
        try
        {
            Console.WriteLine($"ì°¨ëŸ‰ ì¶”ê°€ ì‹œì‘: {vehicle.Name}");
            
            vehicle.Id = Guid.NewGuid().ToString();
            vehicle.CreatedAt = DateTime.Now;
            vehicle.UpdatedAt = DateTime.Now;
            
            Console.WriteLine($"Supabaseì— ì°¨ëŸ‰ ì €ì¥ ì‹œë„...");
            
            // Supabaseì— ì°¨ëŸ‰ ì €ì¥
            var success = await SupabaseService.AddVehicleAsync(vehicle);
            
            Console.WriteLine($"Supabase ì €ì¥ ê²°ê³¼: {success}");
            
            if (success)
            {
                SampleVehicles.Add(vehicle);
                Console.WriteLine($"ì°¨ëŸ‰ì´ Supabaseì— ì €ì¥ë¨: {vehicle.Name}, ID: {vehicle.Id}");
                
                // Supabaseì—ì„œ ë‹¤ì‹œ ì¡°íšŒí•´ì„œ í™•ì¸
                var vehicles = await SupabaseService.GetVehiclesAsync();
                Console.WriteLine($"Supabaseì—ì„œ ì¡°íšŒëœ ì´ ì°¨ëŸ‰ ìˆ˜: {vehicles.Count}");
            }
            else
            {
                Console.WriteLine("Supabase ì €ì¥ ì‹¤íŒ¨, ë¡œì»¬ì—ë§Œ ì €ì¥ë¨");
                SampleVehicles.Add(vehicle);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ì°¨ëŸ‰ ì¶”ê°€ ì˜¤ë¥˜: {ex.Message}");
            Console.WriteLine($"ì˜¤ë¥˜ ìŠ¤íƒ: {ex.StackTrace}");
            SampleVehicles.Add(vehicle);
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleUpdateVehicle((string id, Vehicle updates) args)
    {
        try
        {
            Console.WriteLine($"=== ì°¨ëŸ‰ ìˆ˜ì • ì²˜ë¦¬ ì‹œì‘ ===");
            Console.WriteLine($"ìˆ˜ì •í•  ì°¨ëŸ‰ ID: {args.id}");
            Console.WriteLine($"ìˆ˜ì •í•  ì°¨ëŸ‰ëª…: {args.updates.Name}");
            
            var existingVehicle = SampleVehicles.FirstOrDefault(v => v.Id == args.id);
            if (existingVehicle != null)
            {
                Console.WriteLine($"ê¸°ì¡´ ì°¨ëŸ‰ ë°œê²¬: {existingVehicle.Name}");
                
                // IDì™€ ì‹œê°„ ì •ë³´ ì„¤ì •
                args.updates.Id = args.id;
                args.updates.CreatedAt = existingVehicle.CreatedAt; // ìƒì„± ì‹œê°„ ìœ ì§€
                args.updates.UpdatedAt = DateTime.Now;
                
                Console.WriteLine($"Supabase ì°¨ëŸ‰ ì—…ë°ì´íŠ¸ ì‹œë„...");
                
                // Supabaseì—ì„œ ì°¨ëŸ‰ ì—…ë°ì´íŠ¸
                var success = await SupabaseService.UpdateVehicleAsync(args.updates);
                
                Console.WriteLine($"Supabase ì—…ë°ì´íŠ¸ ê²°ê³¼: {success}");
                
                if (success)
                {
                    var index = SampleVehicles.IndexOf(existingVehicle);
                    SampleVehicles[index] = args.updates;
                    Console.WriteLine($"ì°¨ëŸ‰ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨: {args.updates.Name}");
                }
                else
                {
                    Console.WriteLine("Supabase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨, ë¡œì»¬ì—ë§Œ ì €ì¥ë¨");
                    var index = SampleVehicles.IndexOf(existingVehicle);
                    SampleVehicles[index] = args.updates;
                }
            }
            else
            {
                Console.WriteLine($"ê¸°ì¡´ ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {args.id}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"=== ì°¨ëŸ‰ ìˆ˜ì • ì²˜ë¦¬ ì˜¤ë¥˜ ===");
            Console.WriteLine($"ì˜¤ë¥˜ ë©”ì‹œì§€: {ex.Message}");
            Console.WriteLine($"ì˜¤ë¥˜ ìŠ¤íƒ: {ex.StackTrace}");
            
            var existingVehicle = SampleVehicles.FirstOrDefault(v => v.Id == args.id);
            if (existingVehicle != null)
            {
                var index = SampleVehicles.IndexOf(existingVehicle);
                args.updates.Id = args.id;
                SampleVehicles[index] = args.updates;
                Console.WriteLine("ë¡œì»¬ ëª©ë¡ë§Œ ì—…ë°ì´íŠ¸ë¨");
            }
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleDeleteVehicle(string vehicleId)
    {
        try
        {
            var vehicle = SampleVehicles.FirstOrDefault(v => v.Id == vehicleId);
            if (vehicle != null)
            {
                // Supabaseì—ì„œ ì°¨ëŸ‰ ì‚­ì œ
                var success = await SupabaseService.DeleteVehicleAsync(vehicleId);
                
                if (success)
                {
                    SampleVehicles.Remove(vehicle);
                    Console.WriteLine($"ì°¨ëŸ‰ì´ Supabaseì—ì„œ ì‚­ì œë¨: {vehicle.Name}");
                }
                else
                {
                    Console.WriteLine("Supabase ì‚­ì œ ì‹¤íŒ¨, ë¡œì»¬ì—ì„œë§Œ ì‚­ì œë¨");
                    SampleVehicles.Remove(vehicle);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ì°¨ëŸ‰ ì‚­ì œ ì˜¤ë¥˜: {ex.Message}");
            var vehicle = SampleVehicles.FirstOrDefault(v => v.Id == vehicleId);
            if (vehicle != null)
            {
                SampleVehicles.Remove(vehicle);
            }
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }

    // ì˜ˆì•½ CRUD ë©”ì„œë“œë“¤
    private async Task LoadReservationsFromSupabase()
    {
        try
        {
            Reservations = await SupabaseService.GetReservationsAsync();
            
            if (Reservations.Count > 0)
            {
                Console.WriteLine($"Supabaseì—ì„œ {Reservations.Count}ê°œ ì˜ˆì•½ ë¡œë“œë¨");
            }
            else
            {
                Console.WriteLine("Supabaseì—ì„œ ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ì˜ˆì•½ ë¡œë“œ ì˜¤ë¥˜: {ex.Message}");
            StateHasChanged();
        }
    }

    private async Task HandleAddReservation(Reservation reservation)
    {
        Console.WriteLine($"=== ì˜ˆì•½ ì¶”ê°€ ìš”ì²­ ===");
        Console.WriteLine($"ì˜ˆì•½ì: {reservation.UserName} ({reservation.Department})");
        Console.WriteLine($"ì°¨ëŸ‰: {reservation.VehicleName} (ID: {reservation.VehicleId})");
        Console.WriteLine($"ê¸°ê°„: {reservation.StartDate} {reservation.StartTime} ~ {reservation.EndDate} {reservation.EndTime}");
        Console.WriteLine($"ëª©ì : {reservation.Purpose}");
        Console.WriteLine($"ìƒíƒœ: {reservation.Status}");
        
        try
        {
            // UUIDê°€ ì—†ìœ¼ë©´ ìƒì„±
            if (string.IsNullOrEmpty(reservation.Id))
            {
                reservation.Id = Guid.NewGuid().ToString();
                Console.WriteLine($"ì˜ˆì•½ ID ìƒì„±: {reservation.Id}");
            }
            
            // Supabaseì— ì˜ˆì•½ ì €ì¥
            Console.WriteLine("Supabaseì— ì˜ˆì•½ ì €ì¥ ì‹œë„...");
            var success = await SupabaseService.AddReservationAsync(reservation);
            
            if (success)
            {
                Console.WriteLine("âœ… Supabase ì €ì¥ ì„±ê³µ!");
                
                // ë¡œì»¬ ë¦¬ìŠ¤íŠ¸ì—ë„ ì¶”ê°€
                Reservations.Add(reservation);
                Console.WriteLine($"ë¡œì»¬ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ ì™„ë£Œ. ì´ ì˜ˆì•½ ìˆ˜: {Reservations.Count}");
                
                // ì°¨ëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸
                var vehicle = SampleVehicles.FirstOrDefault(v => v.Id == reservation.VehicleId);
                if (vehicle != null)
                {
                    var oldStatus = vehicle.Status;
                    if (reservation.Status == "reserved" || reservation.Status == "in_use")
                    {
                        vehicle.Status = "InUse";
                    }
                    else if (reservation.Status == "completed" || reservation.Status == "cancelled")
                    {
                        vehicle.Status = "Available";
                    }
                    Console.WriteLine($"ì°¨ëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸: {oldStatus} â†’ {vehicle.Status}");
                    
                    // ì°¨ëŸ‰ ì •ë³´ë„ Supabaseì— ì—…ë°ì´íŠ¸
                    await SupabaseService.UpdateVehicleAsync(vehicle);
                }
                
                Console.WriteLine("=== ì˜ˆì•½ ì¶”ê°€ ì™„ë£Œ! ===");
            }
            else
            {
                Console.WriteLine("âš ï¸ Supabase ì €ì¥ ì‹¤íŒ¨, ë¡œì»¬ì—ë§Œ ì €ì¥");
                Reservations.Add(reservation);
                throw new Exception("Supabaseì— ì˜ˆì•½ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ ì˜ˆì•½ ì €ì¥ ì˜¤ë¥˜: {ex.Message}");
            Console.WriteLine($"ì˜¤ë¥˜ íƒ€ì…: {ex.GetType().Name}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"ë‚´ë¶€ ì˜¤ë¥˜: {ex.InnerException.Message}");
            }
            
            // ì˜¤ë¥˜ ì‹œì—ë„ ë¡œì»¬ì—ëŠ” ì €ì¥ (ì˜¤í”„ë¼ì¸ ì§€ì›)
            if (!Reservations.Any(r => r.Id == reservation.Id))
            {
                Reservations.Add(reservation);
                Console.WriteLine("ë¡œì»¬ì—ë§Œ ì €ì¥ë¨ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)");
            }
            
            // ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            // throw; // ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ ReservationFormì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•  ìˆ˜ ìˆìŒ
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleReservationCancelled(string reservationId)
    {
        Console.WriteLine($"=== ì˜ˆì•½ ì·¨ì†Œ ìš”ì²­ ===");
        Console.WriteLine($"ì˜ˆì•½ ID: {reservationId}");
        
        try
        {
            var reservation = Reservations.FirstOrDefault(r => r.Id == reservationId);
            if (reservation != null)
            {
                Console.WriteLine($"ì˜ˆì•½ì: {reservation.UserName}");
                Console.WriteLine($"ì°¨ëŸ‰: {reservation.VehicleName}");
                
                // Supabaseì—ì„œ ì˜ˆì•½ ì‚­ì œ
                Console.WriteLine("Supabaseì—ì„œ ì˜ˆì•½ ì‚­ì œ ì‹œë„...");
                var success = await SupabaseService.DeleteReservationAsync(reservationId);
                
                if (success)
                {
                    Console.WriteLine("âœ… Supabaseì—ì„œ ì˜ˆì•½ ì‚­ì œ ì„±ê³µ!");
                    
                    // ë¡œì»¬ ë¦¬ìŠ¤íŠ¸ì—ì„œë„ ì œê±°
                    Reservations.Remove(reservation);
                    Console.WriteLine($"ë¡œì»¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±° ì™„ë£Œ. ë‚¨ì€ ì˜ˆì•½ ìˆ˜: {Reservations.Count}");
                    
                    // ì°¨ëŸ‰ ìƒíƒœë¥¼ Availableë¡œ ë³€ê²½
                    var vehicle = SampleVehicles.FirstOrDefault(v => v.Id == reservation.VehicleId);
                    if (vehicle != null)
                    {
                        var oldStatus = vehicle.Status;
                        vehicle.Status = "Available";
                        vehicle.UpdatedAt = DateTime.Now;
                        Console.WriteLine($"ì°¨ëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸: {oldStatus} â†’ {vehicle.Status}");
                        Console.WriteLine($"ì°¨ëŸ‰ëª…: {vehicle.Name}, ì°¨ëŸ‰ID: {vehicle.Id}");
                        
                        // ì°¨ëŸ‰ ì •ë³´ë„ Supabaseì— ì—…ë°ì´íŠ¸
                        Console.WriteLine("Supabaseì— ì°¨ëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„...");
                        var vehicleUpdateSuccess = await SupabaseService.UpdateVehicleAsync(vehicle);
                        
                        if (vehicleUpdateSuccess)
                        {
                            Console.WriteLine("âœ… ì°¨ëŸ‰ ìƒíƒœ Supabase ì—…ë°ì´íŠ¸ ì„±ê³µ!");
                        }
                        else
                        {
                            Console.WriteLine("âš ï¸ ì°¨ëŸ‰ ìƒíƒœ Supabase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
                        }
                    }
                    else
                    {
                        Console.WriteLine($"âŒ ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ. VehicleId: {reservation.VehicleId}");
                    }
                    
                    Console.WriteLine("=== ì˜ˆì•½ ì·¨ì†Œ ì™„ë£Œ! ===");
                }
                else
                {
                    Console.WriteLine("âš ï¸ Supabase ì‚­ì œ ì‹¤íŒ¨, ë¡œì»¬ì—ì„œë§Œ ì œê±°");
                    Reservations.Remove(reservation);
                }
            }
            else
            {
                Console.WriteLine($"âŒ ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {reservationId}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ ì˜ˆì•½ ì·¨ì†Œ ì˜¤ë¥˜: {ex.Message}");
            Console.WriteLine($"ì˜¤ë¥˜ íƒ€ì…: {ex.GetType().Name}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"ë‚´ë¶€ ì˜¤ë¥˜: {ex.InnerException.Message}");
            }
        }
        
        StateHasChanged();
    }

    private async Task HandleReservationCompleted(string reservationId)
    {
        Console.WriteLine($"=== ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬ ìš”ì²­ ===");
        Console.WriteLine($"ì˜ˆì•½ ID: {reservationId}");
        
        try
        {
            var reservation = Reservations.FirstOrDefault(r => r.Id == reservationId);
            if (reservation != null)
            {
                Console.WriteLine($"ì˜ˆì•½ì: {reservation.UserName}");
                Console.WriteLine($"ì°¨ëŸ‰: {reservation.VehicleName}");
                
                var oldStatus = reservation.Status;
                reservation.Status = "completed";
                reservation.UpdatedAt = DateTime.Now;
                
                Console.WriteLine($"ìƒíƒœ ë³€ê²½: {oldStatus} â†’ {reservation.Status}");
                
                // Supabaseì— ì˜ˆì•½ ìƒíƒœ ì—…ë°ì´íŠ¸
                Console.WriteLine("Supabaseì— ì˜ˆì•½ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„...");
                var success = await SupabaseService.UpdateReservationAsync(reservation);
                
                if (success)
                {
                    Console.WriteLine("âœ… Supabaseì— ì˜ˆì•½ ì™„ë£Œ ìƒíƒœ ì €ì¥ ì„±ê³µ!");
                    
                    // ì°¨ëŸ‰ ìƒíƒœë¥¼ Availableë¡œ ë³€ê²½
                    var vehicle = SampleVehicles.FirstOrDefault(v => v.Id == reservation.VehicleId);
                    if (vehicle != null)
                    {
                        var oldVehicleStatus = vehicle.Status;
                        vehicle.Status = "Available";
                        vehicle.UpdatedAt = DateTime.Now;
                        Console.WriteLine($"ì°¨ëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸: {oldVehicleStatus} â†’ {vehicle.Status}");
                        Console.WriteLine($"ì°¨ëŸ‰ëª…: {vehicle.Name}, ì°¨ëŸ‰ID: {vehicle.Id}");
                        
                        // ì°¨ëŸ‰ ì •ë³´ë„ Supabaseì— ì—…ë°ì´íŠ¸
                        Console.WriteLine("Supabaseì— ì°¨ëŸ‰ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„...");
                        var vehicleUpdateSuccess = await SupabaseService.UpdateVehicleAsync(vehicle);
                        
                        if (vehicleUpdateSuccess)
                        {
                            Console.WriteLine("âœ… ì°¨ëŸ‰ ìƒíƒœ Supabase ì—…ë°ì´íŠ¸ ì„±ê³µ!");
                        }
                        else
                        {
                            Console.WriteLine("âš ï¸ ì°¨ëŸ‰ ìƒíƒœ Supabase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
                        }
                        
                        // UI ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•œ StateHasChanged í˜¸ì¶œ
                        StateHasChanged();
                    }
                    else
                    {
                        Console.WriteLine($"âŒ ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ. VehicleId: {reservation.VehicleId}");
                        Console.WriteLine($"ì „ì²´ ì°¨ëŸ‰ ìˆ˜: {SampleVehicles.Count}");
                        foreach (var v in SampleVehicles)
                        {
                            Console.WriteLine($"  - ì°¨ëŸ‰ ID: {v.Id}, ì´ë¦„: {v.Name}");
                        }
                    }
                    
                    Console.WriteLine("=== ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬ ì™„ë£Œ! ===");
                }
                else
                {
                    Console.WriteLine("âš ï¸ Supabase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨, ë¡œì»¬ì—ë§Œ ë°˜ì˜");
                }
            }
            else
            {
                Console.WriteLine($"âŒ ì˜ˆì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {reservationId}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
            Console.WriteLine($"ì˜¤ë¥˜ íƒ€ì…: {ex.GetType().Name}");
            if (ex.InnerException != null)
            {
                Console.WriteLine($"ë‚´ë¶€ ì˜¤ë¥˜: {ex.InnerException.Message}");
            }
        }
        
        StateHasChanged();
    }

    // ìë™ ì™„ë£Œ ì²˜ë¦¬ íƒ€ì´ë¨¸
    private async Task StartAutoCompletionTimer()
    {
        while (true)
        {
            try
            {
                await CheckAndCompleteExpiredReservations();
                await Task.Delay(TimeSpan.FromMinutes(1)); // 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ìë™ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜: {ex.Message}");
                await Task.Delay(TimeSpan.FromMinutes(5)); // ì˜¤ë¥˜ ì‹œ 5ë¶„ í›„ ì¬ì‹œë„
            }
        }
    }

    // ë§Œë£Œëœ ì˜ˆì•½ ìë™ ì™„ë£Œ ì²˜ë¦¬
    private async Task CheckAndCompleteExpiredReservations()
    {
        var now = DateTime.Now;
        var expiredReservations = Reservations
            .Where(r => r.Status != "cancelled" && r.Status != "completed" && 
                       r.EndDateTime < now)
            .ToList();

        if (expiredReservations.Any())
        {
            Console.WriteLine($"=== ìë™ ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘: {expiredReservations.Count}ê°œ ì˜ˆì•½ ===");
            
            foreach (var reservation in expiredReservations)
            {
                try
                {
                    Console.WriteLine($"ìë™ ì™„ë£Œ ì²˜ë¦¬: {reservation.UserName} - {reservation.VehicleName}");
                    
                    // ì˜ˆì•½ ìƒíƒœë¥¼ ì™„ë£Œë¡œ ë³€ê²½
                    var oldStatus = reservation.Status;
                    reservation.Status = "completed";
                    reservation.UpdatedAt = now;
                    
                    Console.WriteLine($"ìƒíƒœ ë³€ê²½: {oldStatus} â†’ completed (ìë™)");
                    
                    // Supabaseì— ì˜ˆì•½ ìƒíƒœ ì—…ë°ì´íŠ¸
                    var reservationUpdateSuccess = await SupabaseService.UpdateReservationAsync(reservation);
                    
                    if (reservationUpdateSuccess)
                    {
                        Console.WriteLine("âœ… ì˜ˆì•½ ìë™ ì™„ë£Œ Supabase ì—…ë°ì´íŠ¸ ì„±ê³µ!");
                        
                        // ì°¨ëŸ‰ ìƒíƒœë¥¼ Availableë¡œ ë³€ê²½
                        var vehicle = SampleVehicles.FirstOrDefault(v => v.Id == reservation.VehicleId);
                        if (vehicle != null)
                        {
                            var oldVehicleStatus = vehicle.Status;
                            vehicle.Status = "Available";
                            vehicle.UpdatedAt = now;
                            
                            Console.WriteLine($"ì°¨ëŸ‰ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸: {oldVehicleStatus} â†’ Available");
                            
                            // ì°¨ëŸ‰ ì •ë³´ë„ Supabaseì— ì—…ë°ì´íŠ¸
                            var vehicleUpdateSuccess = await SupabaseService.UpdateVehicleAsync(vehicle);
                            
                            if (vehicleUpdateSuccess)
                            {
                                Console.WriteLine("âœ… ì°¨ëŸ‰ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸ Supabase ì„±ê³µ!");
                            }
                            else
                            {
                                Console.WriteLine("âš ï¸ ì°¨ëŸ‰ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸ Supabase ì‹¤íŒ¨");
                            }
                        }
                        else
                        {
                            Console.WriteLine($"âŒ ì°¨ëŸ‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ. VehicleId: {reservation.VehicleId}");
                        }
                    }
                    else
                    {
                        Console.WriteLine("âš ï¸ ì˜ˆì•½ ìë™ ì™„ë£Œ Supabase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"ì˜ˆì•½ ìë™ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜ ({reservation.Id}): {ex.Message}");
                }
            }
            
            Console.WriteLine("=== ìë™ ì™„ë£Œ ì²˜ë¦¬ ì™„ë£Œ ===");
            
            // UI ìƒˆë¡œê³ ì¹¨
            StateHasChanged();
        }
    }
}
